<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom"><title>Hans Blog</title><link href="http://hansliu.com/" rel="alternate"></link><link href="http://hansliu.com/feeds/xie-cheng-shi.atom.xml" rel="self"></link><id>http://hansliu.com/</id><updated>2014-04-26T23:00:00+08:00</updated><entry><title>使用 Name expansion + Fabric 同時部屬多台機器</title><link href="http://hansliu.com/posts/2014/04/github-name-expansion.html" rel="alternate"></link><updated>2014-04-26T23:00:00+08:00</updated><author><name>996 / Hans</name></author><id>tag:hansliu.com,2014-04-26:posts/2014/04/github-name-expansion.html</id><summary type="html">&lt;p&gt;前陣子為了完成 Fabric 同時部屬多台機器的功能，寫了一個字串展開的小工具。&lt;/p&gt;
&lt;p&gt;使用 python regular expression 來實作，讓使用者可以利用逗號、數字、括弧將字串批次展開。&lt;/p&gt;
&lt;p&gt;簡單的 use case:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
&amp;gt;&amp;gt;&amp;gt; from name_expansion import NameExpansionCore
&amp;gt;&amp;gt;&amp;gt; ne = NameExpansionCore()

&amp;gt;&amp;gt;&amp;gt; host = '[tw,hk][1-2].host[3,5].com'
&amp;gt;&amp;gt;&amp;gt; host_list = list([host])
&amp;gt;&amp;gt;&amp;gt; for match in ne.parse(host):
...   host_list = ne.expand(match, host_list)
&amp;gt;&amp;gt;&amp;gt; host_list
['tw1.host3.com', 'hk1.host3.com', 'tw1.host5.com', 'hk1.host5.com',
'tw2.host3.com', 'hk2.host3.com', 'tw2.host5.com', 'hk2.host5.com']
&lt;/pre&gt;
&lt;p&gt;Fabric 要部屬的機器是儲存在 env.hosts 裡面，型態是 list，所以我們只要在 fabfile.py 加入一個 method，將 Name expansion 批次展開的結果回存到 env.hosts 裡。&lt;/p&gt;
&lt;pre class="literal-block"&gt;
def h(curr_host):
  ne = NameExpansionCore()
  host_list = list([curr_host])
  for match in ne.parse(curr_host):
    host_list = ne.expand(match, host_list)
  env.hosts = host_list
&lt;/pre&gt;
&lt;p&gt;接著我們就可以透過 Fabric 內建指令 fab，同時指定多台機器做部屬的動作，不過執行部屬的動作是循序的，並不是平行的。&lt;/p&gt;
&lt;pre class="literal-block"&gt;
fab h:host[1-3].com deploy
&lt;/pre&gt;
&lt;p&gt;詳細使用教學可以參照 Github repository 的說明。&lt;/p&gt;
&lt;p&gt;Github repository link: &lt;a class="reference external" href="https://github.com/hansliu/NameExpansion"&gt;https://github.com/hansliu/NameExpansion&lt;/a&gt;&lt;/p&gt;
</summary><category term="Python"></category><category term="Github"></category></entry></feed>